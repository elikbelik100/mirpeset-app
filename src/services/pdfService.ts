// שירות עיבוד PDF - יחליף את הסימולציה
export class PDFService {
  static async extractTextFromPDF(file: File): Promise<string> {
    try {
      // בגרסה זו נשתמש בסימולציה
      // בעתיד ניתן לשלב עם PDF.js או pdf-parse
      
      const fileContent = await this.readFileAsArrayBuffer(file);
      
      // בדיקה פשוטה שזה באמת PDF
      const header = new Uint8Array(fileContent.slice(0, 4));
      const pdfSignature = '%PDF';
      const headerStr = String.fromCharCode(...header);
      
      if (!headerStr.startsWith(pdfSignature.substring(1, 4))) {
        throw new Error('קובץ זה אינו PDF תקין');
      }

      // סימולציה של חילוץ טקסט
      // במציאות כאן נשתמש ב-PDF.js
      return this.simulateTextExtraction();
      
    } catch (error) {
      console.error('שגיאה בחילוץ טקסט מ-PDF:', error);
      throw new Error('לא הצלחנו לקרוא את הקובץ PDF');
    }
  }

  private static readFileAsArrayBuffer(file: File): Promise<ArrayBuffer> {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result as ArrayBuffer);
      reader.onerror = () => reject(reader.error);
      reader.readAsArrayBuffer(file);
    });
  }

  private static simulateTextExtraction(): string {
    // טקסט דוגמה מורחב לבדיקה
    return `
לוח שיעורים שנתי - תשפ״ה
המרפסת - בית מדרש לתורה ולחכמה

=== ינואר 2025 ===
05/01/2025 - 19:00 - שיעור גמרא - מסכת בבא קמא - בית מדרש ראשי
07/01/2025 - 20:00 - הלכה למעשה - דיני שבת - אולם הרצאות  
12/01/2025 - 19:30 - פרשת השבוע - פרשת וירא - בית מדרש ראשי
14/01/2025 - 21:00 - קבלה ורוחניות - עולמות עליונים - חדר קטן
19/01/2025 - 19:00 - שיעור גמרא - מסכת בבא קמא - בית מדרש ראשי
21/01/2025 - 20:30 - חסידות - תניא - חדר מחקר
26/01/2025 - 18:30 - שיעור נשים - הלכות נידה - אולם נשים
28/01/2025 - 20:00 - פילוסופיה יהודית - רמב״ם - ספרייה

=== פברואר 2025 ===
02/02/2025 - 19:00 - שיעור גמרא - מסכת בבא קמא - בית מדרש ראשי
04/02/2025 - 20:00 - הלכה למעשה - דיני תפילה - אולם הרצאות
09/02/2025 - 19:30 - פרשת השבוע - פרשת לך לך - בית מדרש ראשי
11/02/2025 - 21:00 - קבלה ורוחניות - ספירות - חדר קטן
16/02/2025 - 19:00 - שיעור גמרא - מסכת בבא קמא - בית מדרש ראשי
18/02/2025 - 20:30 - חסידות - זוהר - חדר מחקר
23/02/2025 - 18:30 - שיעור נשים - הלכות כשרות - אולם נשים
25/02/2025 - 20:00 - תנ״ך - ספר תהילים - ספרייה

=== מרץ 2025 ===
02/03/2025 - 19:00 - שיעור גמרא - מסכת בבא מציעא - בית מדרש ראשי
04/03/2025 - 20:00 - הלכה למעשה - דיני פסח - אולם הרצאות
09/03/2025 - 19:30 - פרשת השבוע - פרשת ויצא - בית מדרש ראשי
11/03/2025 - 21:00 - קבלה ורוחניות - פרדס - חדר קטן
14/03/2025 - 18:00 - חג פורים - מגילה ומשתה - אולם גדול
16/03/2025 - 19:00 - שיעור גמרא - מסכת בבא מציעא - בית מדרש ראשי
18/03/2025 - 20:30 - חסידות - ליקוטי מוהר״ן - חדר מחקר
23/03/2025 - 18:30 - שיעור נשים - הלכות יו״ט - אולם נשים
25/03/2025 - 20:00 - משנה - מסכת ברכות - ספרייה
30/03/2025 - 17:30 - הכנה לפסח - סדר פסח - אולם גדול

=== אפריל 2025 ===
06/04/2025 - 19:00 - שיעור גמרא - מסכת בבא מציעא - בית מדרש ראשי
08/04/2025 - 20:00 - הלכה למעשה - דיני ספירת העומר - אולם הרצאות
13/04/2025 - 19:30 - פרשת השבוע - פרשת וישלח - בית מדרש ראשי
14/04/2025 - 18:00 - חג פסח - ליל סדר ראשון - אולם גדול
15/04/2025 - 19:00 - חג פסח - ליל סדר שני - אולם גדול
20/04/2025 - 19:00 - שיעור גמרא - מסכת בבא מציעא - בית מדרש ראשי
22/04/2025 - 21:00 - קבלה ורוחניות - גלגולים - חדר קטן
27/04/2025 - 18:30 - שיעור נשים - הלכות חול המועד - אולם נשים
29/04/2025 - 20:00 - אגדה - מדרש רבה - ספרייה

=== מאי 2025 ===
04/05/2025 - 19:00 - שיעור גמרא - מסכת בבא בתרא - בית מדרש ראשי
06/05/2025 - 20:00 - הלכה למעשה - דיני יום טוב - אולם הרצאות
11/05/2025 - 19:30 - פרשת השבוע - פרשת וישב - בית מדרש ראשי
13/05/2025 - 21:00 - קבלה ורוחניות - אצילות - חדר קטן
14/05/2025 - 18:00 - ל״ג בעומר - הדלקת מדורה - חצר
18/05/2025 - 19:00 - שיעור גמרא - מסכת בבא בתרא - בית מדרש ראשי
20/05/2025 - 20:30 - חסידות - ספר התניא - חדר מחקר
25/05/2025 - 18:30 - שיעור נשים - הלכות נדרים - אולם נשים
27/05/2025 - 20:00 - פרקי אבות - פרק א - ספרייה

הערות:
- כל השיעורים ברמה בינונית אלא אם צוין אחרת
- הרשמה מוקדמת נדרשת לשיעורים מיוחדים
- שינויים אפשריים בתאריכים עקב חגים
`;
  }

  // פונקציות עזר לזיהוי וניתוח התוכן
  static identifyLessonPattern(_text: string): RegExp[] {
    return [
      // פטרן רגיל: תאריך - שעה - כותרת - מקום (תומך בשנה 2-4 ספרות)
      /(\d{1,2}\/\d{1,2}\/\d{2,4})\s*-\s*(\d{1,2}:\d{2})\s*-\s*([^-]+?)(?:\s*-\s*(.+?))?$/gm,
      
      // פטרן עם נקודות או רווחים נוספים (תומך בשנה 2-4 ספרות)
      /(\d{1,2}[\.\/]\d{1,2}[\.\/]\d{2,4})\s*[-:]\s*(\d{1,2}[:\.]\d{2})\s*[-:]\s*(.+?)(?:\s*[-:]\s*(.+?))?$/gm,
      
      // פטרן עברי: ד' אדר תשפ"ה
      /([\u0590-\u05FF\s\d"']+)\s*-\s*(\d{1,2}:\d{2})\s*-\s*([^-]+?)(?:\s*-\s*(.+?))?$/gm
    ];
  }

  static suggestLessonCategories(title: string): string {
    const titleLower = title.toLowerCase();
    
    if (titleLower.includes('גמרא') || titleLower.includes('מסכת')) {
      return 'גמרא';
    }
    if (titleLower.includes('הלכה') || titleLower.includes('דיני')) {
      return 'הלכה';
    }
    if (titleLower.includes('פרשת') || titleLower.includes('פרשה')) {
      return 'פרשת השבוע';
    }
    if (titleLower.includes('קבלה') || titleLower.includes('זוהר') || 
        titleLower.includes('ספירות') || titleLower.includes('עולמות')) {
      return 'קבלה ורוחניות';
    }
    if (titleLower.includes('חסידות') || titleLower.includes('תניא') || 
        titleLower.includes('ליקוטי')) {
      return 'חסידות';
    }
    if (titleLower.includes('חג') || titleLower.includes('יום טוב') || 
        titleLower.includes('פסח') || titleLower.includes('פורים')) {
      return 'אירועים מיוחדים';
    }
    if (titleLower.includes('נשים') || titleLower.includes('נידה') || 
        titleLower.includes('כשרות')) {
      return 'שיעורי נשים';
    }
    if (titleLower.includes('תנך') || titleLower.includes('תהילים') || 
        titleLower.includes('נביאים')) {
      return 'תנך';
    }
    if (titleLower.includes('משנה') || titleLower.includes('ברכות')) {
      return 'משנה';
    }
    if (titleLower.includes('פילוסופיה') || titleLower.includes('רמבם') || 
        titleLower.includes('מורה נבוכים')) {
      return 'פילוסופיה יהודית';
    }
    
    return 'כולל יום שישי';
  }
}
